<!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Document AI Chat - Chat</title>
     <style>
         body {
             font-family: Arial, sans-serif;
             margin: 0;
             padding: 0;
             height: 100vh;
             display: flex;
             flex-direction: column;
         }
         .header {
             background-color: #f5f5f5;
             padding: 15px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             border-bottom: 1px solid #ddd;
         }
         .document-title {
             font-weight: bold;
             color: #333;
         }
         .nav-links a {
             margin-left: 15px;
             text-decoration: none;
             color: #4285f4;
         }
         .chat-container {
             display: flex;
             flex-direction: column;
             flex: 1;
             max-width: 1000px;
             margin: 0 auto;
             width: 100%;
             padding: 0 20px;
             box-sizing: border-box;
         }
         .messages-container {
             flex: 1;
             overflow-y: auto;
             padding: 20px 0;
         }
         .message {
             margin-bottom: 20px;
             display: flex;
         }
         .user-message {
             justify-content: flex-end;
         }
         .bot-message {
             justify-content: flex-start;
         }
         .message-content {
             max-width: 70%;
             padding: 12px 16px;
             border-radius: 18px;
             word-wrap: break-word;
         }
         .user-message .message-content {
             background-color: #4285f4;
             color: white;
         }
         .bot-message .message-content {
             background-color: #f1f1f1;
         }
         .input-container {
             display: flex;
             padding: 15px 0;
             border-top: 1px solid #ddd;
         }
         .message-input {
             flex: 1;
             padding: 12px;
             border: 1px solid #ddd;
             border-radius: 24px;
             font-size: 16px;
             outline: none;
         }
         .send-button {
             background-color: #4285f4;
             color: white;
             border: none;
             width: 40px;
             height: 40px;
             border-radius: 50%;
             margin-left: 10px;
             cursor: pointer;
             display: flex;
             justify-content: center;
             align-items: center;
             font-size: 18px;
         }
         .send-button:hover {
             background-color: #3367d6;
         }
         .send-button:disabled {
             background-color: #a8a8a8;
             cursor: not-allowed;
         }
         .error {
             color: red;
             padding: 10px;
             text-align: center;
             display: none;
         }
         .loading {
             text-align: center;
             padding: 20px;
             color: #666;
             display: none;
         }
         pre {
             background-color: #f5f5f5;
             padding: 10px;
             border-radius: 5px;
             overflow-x: auto;
             white-space: pre-wrap;
         }
         code {
             font-family: monospace;
         }
     </style>
 </head>
 <body>
     <div class="header">
         <div class="document-title" id="documentTitle">Loading document...</div>
         <div class="nav-links">
             <a href="upload.html">Upload New Document</a>
             <a href="#" id="logoutLink">Logout</a>
         </div>
     </div>
     
     <div class="chat-container">
         <div id="loading" class="loading">Loading your document...</div>
         <div id="errorMessage" class="error"></div>
         
         <div class="messages-container" id="messagesContainer">
             <!-- Messages will be inserted here dynamically -->
         </div>
         
         <div class="input-container">
             <input type="text" class="message-input" id="messageInput" placeholder="Ask a question about your document..." autocomplete="off">
             <button class="send-button" id="sendButton" title="Send message">âž¤</button>
         </div>
     </div>
 
     <script>
         // Get document ID from URL
         const urlParams = new URLSearchParams(window.location.search);
         const docId = urlParams.get('doc_id');
         
         // DOM elements
         const documentTitle = document.getElementById('documentTitle');
         const messagesContainer = document.getElementById('messagesContainer');
         const messageInput = document.getElementById('messageInput');
         const sendButton = document.getElementById('sendButton');
         const errorMessage = document.getElementById('errorMessage');
         const loading = document.getElementById('loading');
         const logoutLink = document.getElementById('logoutLink');
         
         // Check if token exists and redirect to login if not
         document.addEventListener('DOMContentLoaded', function() {
             const token = localStorage.getItem('token');
             if (!token) {
                 window.location.href = 'index.html';
                 return;
             }
             
             // Check if document ID exists in URL
             if (!docId) {
                 errorMessage.textContent = 'Document ID not found. Please upload a document first.';
                 errorMessage.style.display = 'block';
                 loading.style.display = 'none';
                 return;
             }
             
             // Fetch document info
             fetchDocumentInfo();
             
             // Add welcome message
             addBotMessage("Hello! I'm your document assistant. Ask me anything about your document.");
         });
         
         // Logout functionality
         logoutLink.addEventListener('click', function(e) {
             e.preventDefault();
             localStorage.removeItem('token');
             window.location.href = 'index.html';
         });
         
         // Handle message sending
         messageInput.addEventListener('keypress', function(e) {
             if (e.key === 'Enter' && messageInput.value.trim() !== '') {
                 sendMessage();
             }
         });
         
         sendButton.addEventListener('click', function() {
             if (messageInput.value.trim() !== '') {
                 sendMessage();
             }
         });
         
         // Function to fetch document info
         async function fetchDocumentInfo() {
             const token = localStorage.getItem('token');
             
             try {
                 const response = await fetch(`http://127.0.0.1:5000/uploads/document/${docId}`, {
                     method: 'GET',
                     headers: {
                         'Authorization': `Bearer ${token}`
                     }
                 });
                 
                 if (response.ok) {
                     const data = await response.json();
                     documentTitle.textContent = data.filename || 'Document Chat';
                     loading.style.display = 'none';
                 } else {
                     const data = await response.json();
                     errorMessage.textContent = data.message || 'Failed to load document information.';
                     errorMessage.style.display = 'block';
                     loading.style.display = 'none';
                 }
             } catch (error) {
                 console.error('Error fetching document info:', error);
                 errorMessage.textContent = 'An error occurred while loading document information.';
                 errorMessage.style.display = 'block';
                 loading.style.display = 'none';
             }
         }
         
         // Function to send a message
         async function sendMessage() {
             const message = messageInput.value.trim();
             if (!message) return;
             
             // Add user message to UI
             addUserMessage(message);
             
             // Clear input
             messageInput.value = '';
             
             // Disable send button while waiting for response
             sendButton.disabled = true;
             
             // Show typing indicator
             const typingIndicator = addTypingIndicator();
             
             // Get token
             const token = localStorage.getItem('token');
             
             try {
                 const response = await fetch(`http://127.0.0.1:5000/chat/ask/${docId}`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({ query: message })
                 });
                 
                 // Remove typing indicator
                 if (typingIndicator) {
                     messagesContainer.removeChild(typingIndicator);
                 }
                 
                 if (response.ok) {
                     const data = await response.json();
                     
                     // Add bot response to UI
                     addBotMessage(data.reply || 'I processed your request.');
                 } else {
                     const data = await response.json();
                     addBotMessage(`Error: ${data.message || 'Something went wrong. Please try again.'}`);
                 }
             } catch (error) {
                 console.error('Error sending message:', error);
                 
                 // Remove typing indicator
                 if (typingIndicator) {
                     messagesContainer.removeChild(typingIndicator);
                 }
                 
                 addBotMessage('Sorry, there was an error processing your request. Please try again later.');
             } finally {
                 // Re-enable send button
                 sendButton.disabled = false;
                 
                 // Scroll to bottom
                 scrollToBottom();
             }
         }
         
         // Function to add user message to UI
         function addUserMessage(text) {
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message user-message';
             
             const contentDiv = document.createElement('div');
             contentDiv.className = 'message-content';
             contentDiv.textContent = text;
             
             messageDiv.appendChild(contentDiv);
             messagesContainer.appendChild(messageDiv);
             
             scrollToBottom();
         }
         
         // Function to add bot message to UI
         function addBotMessage(text) {
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message bot-message';
             
             const contentDiv = document.createElement('div');
             contentDiv.className = 'message-content';
             
             // Process markdown-like formatting for code
             const formattedText = formatText(text);
             contentDiv.innerHTML = formattedText;
             
             messageDiv.appendChild(contentDiv);
             messagesContainer.appendChild(messageDiv);
             
             scrollToBottom();
         }
         
         // Function to format text with basic markdown
         function formatText(text) {
             // Handle code blocks
             text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
             
             // Handle inline code
             text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
             
             // Handle line breaks
             text = text.replace(/\n/g, '<br>');
             
             return text;
         }
         
         // Function to add typing indicator
         function addTypingIndicator() {
             const typingDiv = document.createElement('div');
             typingDiv.className = 'message bot-message';
             typingDiv.id = 'typingIndicator';
             
             const contentDiv = document.createElement('div');
             contentDiv.className = 'message-content';
             contentDiv.textContent = 'Thinking...';
             
             typingDiv.appendChild(contentDiv);
             messagesContainer.appendChild(typingDiv);
             
             scrollToBottom();
             
             return typingDiv;
         }
         
         // Function to scroll to the bottom of the chat
         function scrollToBottom() {
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
         }
     </script>
 </body>
 </html>